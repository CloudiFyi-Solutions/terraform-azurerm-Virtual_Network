jobs:
  generate-docs:
    name: Generate Terraform Docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Set up OS and architecture
        run: |
          echo "Setting up OS and architecture"

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            os="linux"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            os="darwin"
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            os="windows"
          fi

          architecture=$(uname -m)

          if [[ "$architecture" == "x86_64" ]]; then
            architecture="amd64"
          elif [[ "$architecture" == "aarch64" ]]; then
            architecture="arm64"
          fi

          echo "OS: $os"
          echo "Architecture: $architecture"

          echo "os=$os" >> $GITHUB_ENV
          echo "architecture=$architecture" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Download terraform-docs
        run: |
          version=$(curl -s https://api.github.com/repos/terraform-docs/terraform-docs/releases/latest | jq -r .tag_name)
          echo "Version of terraform-docs: $version"

          download_url="https://github.com/terraform-docs/terraform-docs/releases/download/${version}/terraform-docs-${version}-${os}-${architecture}"
          echo "Download URL: $download_url"

          curl -Lo /usr/local/bin/terraform-docs "$download_url"

          # Inspect the downloaded file
          echo "File contents:"
          cat /usr/local/bin/terraform-docs
          chmod +x /usr/local/bin/terraform-docs

      - name: Verify terraform-docs installation
        run: |
          echo "Verifying the terraform-docs installation"
          ls -l /usr/local/bin/terraform-docs
          file /usr/local/bin/terraform-docs
          /usr/local/bin/terraform-docs --version  # Ensure it runs

      - name: Generate Terraform Docs
        run: |
          /usr/local/bin/terraform-docs markdown . > README.md